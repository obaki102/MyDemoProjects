@using System.Security.Claims
<MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopLeft">
    <ActivatorContent>
        @if (string.IsNullOrEmpty(_picUrl))
        {
            <MudAvatar Color="Color.Secondary">@_firstName[0]</MudAvatar>
        }
        else
        {
            <MudAvatar Image="@_picUrl" Style="height:50px; width:50px;"> </MudAvatar>
        }
    </ActivatorContent>
    <ChildContent>
        <MudMenuItem>
            <MudCard Elevation="0" Square="true" Class="mt-n2">
                <MudCardHeader>
                    <CardHeaderAvatar>
                        @if (string.IsNullOrEmpty(_picUrl))
                        {
                            <MudAvatar Color="Color.Secondary">@claims[ClaimTypes.Name][0]</MudAvatar>
                        }
                        else
                        {
                            <MudAvatar Image="@_picUrl" Style="height:50px; width:50px;"> </MudAvatar>
                        }
                    </CardHeaderAvatar>
                    <CardHeaderContent>
                        <MudText Typo="Typo.caption">@claims[ClaimTypes.Email]</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
            </MudCard>
        </MudMenuItem>
        <MudDivider Class="mb-2" />
        <MudListItem Icon="@Icons.Filled.Logout" Text="Sign Out" OnClick="SignOut" />
    </ChildContent>
</MudMenu>


@code {
    [Inject] private IDialogService _dialogService { get; set; } = default!;
    [Inject] private IRetrieveAuthState _retrieveAuthState { get; set; } = default!;
    [Inject] private CustomAuthStateProvider _customAuthStateProvider { get; set; } = default!;
    private bool _drawerProfileOpen = true;
    private bool _drawerOpen = true;
    private Dictionary<string, string> claims = new Dictionary<string, string>();
    private string _picUrl = string.Empty;
    private string _firstName = "Temp";
    private void OpenDialog()
    {
        _dialogService.Show<Login>("Login", new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true, NoHeader = true });
    }


    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
    private void ToggleProfileDrawer()
    {
        _drawerProfileOpen = !_drawerProfileOpen;
    }
    private async Task SignOut()
    {
        await _customAuthStateProvider.LogOutAndUpdateAuthenticationState();
    }

    protected override async Task OnInitializedAsync()
    {
        claims = await _retrieveAuthState.GetClaimValues();
        if (claims.ContainsKey(ApplicationClaimTypes.ProfilePictureDataUrl))
        {
            _picUrl = claims[ApplicationClaimTypes.ProfilePictureDataUrl];
        }

        if (claims.ContainsKey(ClaimTypes.Name))
        {
            _firstName = claims[ClaimTypes.Name];
        }
        
    }
}
